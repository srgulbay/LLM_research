{% extends "admin/admin_layout.html" %}
{% block title %}Vaka Düzenle: {{ case.content.title }}{% endblock %}

{% block admin_content %}
<div class="mb-8">
     <a href="{{ url_for('research_admin_dashboard', research_id=case.research_id) }}" class="text-blue-600 dark:text-blue-400 mb-4 inline-block">← Geri</a>
    <h2 class="text-3xl font-bold text-slate-900 dark:text-white">Vaka Düzenleyici</h2>
    <p class="text-slate-500 dark:text-slate-400 mt-1">{{ case.content.title }}</p>
</div>

<form method="POST" id="case-editor-form" class="space-y-8">
    
    <div class="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg">
        <h3 class="font-bold text-slate-900 dark:text-white mb-4">Temel Vaka Bilgileri</h3>
        <div class="space-y-4">
            <div>
                <label for="title" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Vaka Başlığı</label>
                <input type="text" id="title" name="title" value="{{ case.content.title }}" required
                       class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            {% for section in case.content.sections %}
                 <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">{{ section.title }}</label>
                    <textarea name="section_{{ loop.index0 }}" rows="4" 
                              class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">{{ section.content }}</textarea>
                </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg">
        <h3 class="font-bold text-slate-900 dark:text-white mb-4">Anket Soruları & Altın Standart</h3>
        <div id="questions-container" class="space-y-6">
            {% for q in case.content.questions %}
            <div class="question-block bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-700 p-4 rounded-lg space-y-3">
                <input type="hidden" name="question_id" value="{{ q.id }}">
                <div>
                    <label class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">Soru Metni</label>
                    <input type="text" name="question_label" value="{{ q.label }}" required
                           class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm">
                </div>
                 <div>
                    <label class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">Soru Tipi</label>
                    <select name="question_type" class="question-type-select w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm">
                        <option value="open-ended" {% if q.type == 'open-ended' %}selected{% endif %}>Açık Uçlu (Kısa Metin)</option>
                        <option value="textarea" {% if q.type == 'textarea' %}selected{% endif %}>Açık Uçlu (Uzun Metin)</option>
                        <option value="multiple-choice" {% if q.type == 'multiple-choice' %}selected{% endif %}>Çoktan Seçmeli</option>
                    </select>
                </div>
                <div class="options-container" style="display: {{ 'block' if q.type == 'multiple-choice' else 'none' }};">
                    <label class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">Seçenekler (Her satıra bir tane)</label>
                    <textarea name="question_options" rows="3" 
                              class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm">{% if q.options %}{{ q.options | join('\n') }}{% endif %}</textarea>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-green-700 dark:text-green-400 mb-1">Altın Standart Cevap</label>
                    <input type="text" name="gold_standard_{{ q.id }}" value="{{ case.content.gold_standard.get(q.id, '') }}" 
                           class="w-full px-3 py-1.5 border border-green-300 dark:border-green-700 bg-green-50 dark:bg-green-900/20 rounded-md text-sm">
                </div>
                <button type="button" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 text-xs font-semibold" onclick="removeQuestionBlock(this)">Soruyu Sil</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" id="add-question-btn" class="mt-4 bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300 text-sm font-semibold px-4 py-2 rounded-lg hover:bg-green-200 dark:hover:bg-green-900/40">+ Yeni Soru Ekle</button>
    </div>

     <div class="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg">
        <h3 class="font-bold text-slate-900 dark:text-white mb-4">LLM Yanıtları (JSON Formatında Yapıştırın)</h3>
        <div class="space-y-4">
            {% for llm in all_llms %}
            <div>
                <label for="llm_response_{{ llm.name }}" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">{{ llm.name }} Yanıtı</label>
                {# Placeholder güncellendi #}
                <textarea id="llm_response_{{ llm.name }}" name="llm_response_{{ llm.name }}" rows="6" placeholder='{&#10;  "answers": {&#10;    "q1_id": "Seçilen Cevap Metni",&#10;    "q2_id": "..."&#10;  },&#10;  "confidence_score": 85,&#10;  "rationale": "Kısa gerekçe..."&#10;}'
                          class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-xs">{{ case.content.llm_responses.get(llm.name, '') }}</textarea>
            </div>
            {% endfor %}
             {% if not all_llms %}
              <p class="text-sm text-slate-500 dark:text-slate-400">Sistemde tanımlı LLM modeli bulunmuyor. <a href="{{ url_for('manage_llms') }}" class="text-blue-600 dark:text-blue-400">LLM Modelleri</a> sayfasından ekleyebilirsiniz.</p>
            {% endif %}
        </div>
    </div>

    <div class="bg-indigo-50 dark:bg-indigo-900/30 p-6 rounded-xl shadow-lg border border-indigo-200 dark:border-indigo-800 space-y-6">
    <h3 class="font-bold text-indigo-900 dark:text-indigo-200 text-lg">Otomatik LLM Prompt Şablonları</h3>
    <p class="text-xs text-indigo-700 dark:text-indigo-300">Aşağıdaki prompt şablonlarından birini kopyalayıp harici bir LLM'e (ChatGPT, Gemini vb.) yapıştırın. Aldığınız JSON yanıtını aşağıdaki ilgili LLM yanıt alanına yapıştırın.</p>

    {# Uzman Hekim Prompt #}
    <div>
        <div class="flex justify-between items-center mb-1">
            <label for="prompt-uzman-area" class="block text-sm font-semibold text-indigo-800 dark:text-indigo-300">Uzman Hekim Prompt'u</label>
            <button type="button" onclick="copyPrompt('prompt-uzman-area')" class="bg-indigo-600 text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-indigo-700">Kopyala</button>
        </div>
        <textarea id="prompt-uzman-area" rows="10" readonly class="w-full px-3 py-2 border border-indigo-300 dark:border-indigo-700 bg-white dark:bg-slate-900 rounded-md font-mono text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500">{{ llm_prompts.uzman }}</textarea>
    </div>

    {# Hekim Prompt #}
    <div>
        <div class="flex justify-between items-center mb-1">
            <label for="prompt-hekim-area" class="block text-sm font-semibold text-indigo-800 dark:text-indigo-300">Hekim Prompt'u</label>
            <button type="button" onclick="copyPrompt('prompt-hekim-area')" class="bg-indigo-600 text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-indigo-700">Kopyala</button>
        </div>
        <textarea id="prompt-hekim-area" rows="10" readonly class="w-full px-3 py-2 border border-indigo-300 dark:border-indigo-700 bg-white dark:bg-slate-900 rounded-md font-mono text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500">{{ llm_prompts.hekim }}</textarea>
    </div>

    {# Rolsüz Prompt #}
    <div>
        <div class="flex justify-between items-center mb-1">
            <label for="prompt-rolsuz-area" class="block text-sm font-semibold text-indigo-800 dark:text-indigo-300">Rolsüz Prompt</label>
            <button type="button" onclick="copyPrompt('prompt-rolsuz-area')" class="bg-indigo-600 text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-indigo-700">Kopyala</button>
        </div>
        <textarea id="prompt-rolsuz-area" rows="10" readonly class="w-full px-3 py-2 border border-indigo-300 dark:border-indigo-700 bg-white dark:bg-slate-900 rounded-md font-mono text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500">{{ llm_prompts.rolsuz }}</textarea>
    </div>
</div>

<script>
function copyPrompt(textareaId) {
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;

    textarea.select();
    textarea.setSelectionRange(0, 99999);
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            alert('Prompt panoya kopyalandı!');
        } else {
            alert('Otomatik kopyalama başarısız oldu. Tarayıcı izinlerini kontrol edin veya manuel kopyalayın.');
        }
    } catch (err) {
        alert('Otomatik kopyalama sırasında hata oluştu. Lütfen manuel olarak kopyalayın.');
        console.error('Copy error:', err);
    }
    window.getSelection().removeAllRanges();
}
</script>

    <div class="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg">
        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700">Değişiklikleri Kaydet</button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionsContainer = document.getElementById('questions-container');

    // Soru tipi değiştikçe seçenekler kutusunu göster/gizle (Event delegation)
    questionsContainer.addEventListener('change', function(e) {
        if (e.target.classList.contains('question-type-select')) {
            const questionBlock = e.target.closest('.question-block');
            const optionsContainer = questionBlock.querySelector('.options-container');
            if (optionsContainer) {
                optionsContainer.style.display = e.target.value === 'multiple-choice' ? 'block' : 'none';
            }
        }
    });

    // Yeni soru ekleme butonu
    document.getElementById('add-question-btn').addEventListener('click', function() {
        const newId = 'q_new_' + Date.now(); // Benzersiz ID
        const questionHtml = `
            <div class="question-block bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-700 p-4 rounded-lg space-y-3">
                <input type="hidden" name="question_id" value="${newId}">
                <div>
                    <label class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">Soru Metni</label>
                    <input type="text" name="question_label" value="" required class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm">
                </div>
                 <div>
                    <label class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">Soru Tipi</label>
                    <select name="question_type" class="question-type-select w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm">
                        <option value="open-ended" selected>Açık Uçlu (Kısa Metin)</option>
                        <option value="textarea">Açık Uçlu (Uzun Metin)</option>
                        <option value="multiple-choice">Çoktan Seçmeli</option>
                    </select>
                </div>
                <div class="options-container" style="display: none;">
                    <label class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">Seçenekler (Her satıra bir tane)</label>
                    <textarea name="question_options" rows="3" class="w-full px-3 py-1.5 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md text-sm"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-green-700 dark:text-green-400 mb-1">Altın Standart Cevap</label>
                    <input type="text" name="gold_standard_${newId}" value="" class="w-full px-3 py-1.5 border border-green-300 dark:border-green-700 bg-green-50 dark:bg-green-900/20 rounded-md text-sm">
                </div>
                <button type="button" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 text-xs font-semibold" onclick="removeQuestionBlock(this)">Soruyu Sil</button>
            </div>
        `;
        questionsContainer.insertAdjacentHTML('beforeend', questionHtml);
    });
});

// Soruyu silme fonksiyonu
function removeQuestionBlock(button) {
    button.closest('.question-block').remove();
}
</script>
{% endblock %}
